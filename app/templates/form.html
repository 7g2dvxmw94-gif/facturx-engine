<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cr√©er une facture - Factur-X</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; color: #333; }
        header { background: #2c3e50; color: white; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; }
        header h1 { font-size: 22px; }
        header a { color: #3498db; text-decoration: none; font-size: 14px; }
        .container { max-width: 900px; margin: 30px auto; padding: 0 20px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 25px; margin-bottom: 20px; }
        .card h2 { font-size: 16px; color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #3498db; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        label { font-size: 13px; color: #666; display: block; margin-bottom: 4px; }
        input, select { width: 100%; padding: 9px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        input:focus, select:focus { outline: none; border-color: #3498db; }
        .field { margin-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 10px; text-align: left; font-size: 13px; color: #666; border-bottom: 2px solid #eee; }
        td { padding: 8px 5px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
        td input, td select { padding: 7px; font-size: 13px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; font-size: 16px; padding: 14px 30px; width: 100%; }
        .btn-success:hover { background: #219a52; }
        .btn-danger { background: #e74c3c; color: white; padding: 6px 12px; font-size: 12px; }
        .btn-add { background: #ecf0f1; color: #2c3e50; border: 1px dashed #bdc3c7; width: 100%; padding: 10px; margin-top: 10px; cursor: pointer; border-radius: 4px; }
        .btn-add:hover { background: #d5dbdb; }
        .totals { text-align: right; padding: 15px 0; }
        .totals p { margin: 5px 0; font-size: 15px; color: #666; }
        .totals .total-ttc { font-size: 20px; font-weight: bold; color: #2c3e50; }
        .alert { padding: 12px 16px; border-radius: 4px; margin-bottom: 15px; font-size: 14px; }
        .alert-error { background: #fde8e8; color: #c0392b; border: 1px solid #f5c6c6; }
        .alert-success { background: #d5f5e3; color: #1e8449; border: 1px solid #a9dfbf; }
        .login-box { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 400px; margin: 100px auto; }
        .login-box h2 { margin-bottom: 20px; color: #2c3e50; }
        .spinner { display: none; text-align: center; padding: 20px; color: #3498db; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2>üîê Factur-X</h2>
        <p style="color:#666; margin-bottom:20px">Connectez-vous avec votre cl√© API</p>
        <div class="field">
            <label>Cl√© API</label>
            <input type="password" id="api-key-input" placeholder="Votre cl√© API" />
        </div>
        <br>
        <button class="btn btn-primary" style="width:100%" onclick="login()">Se connecter</button>
        <p style="color:red; margin-top:10px" id="login-error"></p>
    </div>
</div>

<div id="app" style="display:none">
    <header>
        <h1>üìÑ Nouvelle facture</h1>
        <a href="/dashboard">‚Üê Tableau de bord</a>
    </header>

    <div class="container">
        <div id="alert-box"></div>

        <!-- Infos facture -->
        <div class="card">
            <h2>üìã Informations facture</h2>
            <div class="grid-3">
                <div class="field">
                    <label>Num√©ro de facture *</label>
                    <input type="text" id="invoice_number" placeholder="FA-2024-001" />
                </div>
                <div class="field">
                    <label>Date d'√©mission *</label>
                    <input type="date" id="issue_date" />
                </div>
                <div class="field">
                    <label>Date d'√©ch√©ance</label>
                    <input type="date" id="due_date" />
                </div>
            </div>
            <div class="grid-2" style="margin-top:15px">
                <div class="field">
                    <label>Conditions de paiement</label>
                    <input type="text" id="payment_terms" placeholder="Virement 30 jours" />
                </div>
                <div class="field">
                    <label>IBAN</label>
                    <input type="text" id="bank_iban" placeholder="FR76..." />
                </div>
            </div>
        </div>

        <!-- Vendeur -->
        <div class="card">
            <h2>üè¢ Vendeur 
                <button class="btn btn-primary" style="float:right; font-size:12px; padding:6px 12px" onclick="saveSellerTemplate()">üíæ Sauvegarder comme mod√®le</button>
            </h2>
            <div class="grid-2">
                <div class="field"><label>Nom *</label><input type="text" id="seller_name" placeholder="ACME SAS" /></div>
                <div class="field"><label>SIRET *</label><input type="text" id="seller_siret" placeholder="12345678900017" maxlength="14" /></div>
                <div class="field"><label>N¬∞ TVA *</label><input type="text" id="seller_vat" placeholder="FR12345678900" /></div>
                <div class="field"><label>Rue *</label><input type="text" id="seller_street" placeholder="12 rue de la Paix" /></div>
                <div class="field"><label>Ville *</label><input type="text" id="seller_city" placeholder="Paris" /></div>
                <div class="field"><label>Code postal *</label><input type="text" id="seller_postal" placeholder="75001" maxlength="5" /></div>
            </div>
        </div>

        <!-- Acheteur -->
        <div class="card">
            <h2>üë§ Acheteur</h2>
            <div class="grid-2">
                <div class="field"><label>Nom *</label><input type="text" id="buyer_name" placeholder="CLIENT SARL" /></div>
                <div class="field"><label>SIRET *</label><input type="text" id="buyer_siret" placeholder="98765432100012" maxlength="14" /></div>
                <div class="field"><label>N¬∞ TVA *</label><input type="text" id="buyer_vat" placeholder="FR98765432100" /></div>
                <div class="field"><label>Rue *</label><input type="text" id="buyer_street" placeholder="5 avenue Victor Hugo" /></div>
                <div class="field"><label>Ville *</label><input type="text" id="buyer_city" placeholder="Lyon" /></div>
                <div class="field"><label>Code postal *</label><input type="text" id="buyer_postal" placeholder="69001" maxlength="5" /></div>
            </div>
        </div>

        <!-- Lignes -->
        <div class="card">
            <h2>üì¶ Lignes de facturation</h2>
            <table>
                <thead>
                    <tr>
                        <th style="width:35%">Description</th>
                        <th style="width:10%">Qt√©</th>
                        <th style="width:12%">Unit√©</th>
                        <th style="width:15%">PU HT (‚Ç¨)</th>
                        <th style="width:10%">TVA %</th>
                        <th style="width:13%">Total HT</th>
                        <th style="width:5%"></th>
                    </tr>
                </thead>
                <tbody id="lines-tbody"></tbody>
            </table>
            <button class="btn-add" onclick="addLine()">+ Ajouter une ligne</button>
            <div class="totals">
                <p>Total HT : <strong id="total-ht">0,00 ‚Ç¨</strong></p>
                <p>TVA : <strong id="total-vat">0,00 ‚Ç¨</strong></p>
                <p class="total-ttc">Total TTC : <span id="total-ttc">0,00 ‚Ç¨</span></p>
            </div>
        </div>

        <div class="spinner" id="spinner">‚è≥ G√©n√©ration en cours...</div>
        <button class="btn btn-success" onclick="generateInvoice()">üì• G√©n√©rer la facture Factur-X</button>
        <br><br>
    </div>
</div>

<script>
let apiKey = '';
let lineCount = 0;
const BASE_URL = window.location.origin;

// Dates g√©r√©es dans window.addEventListener load

function prefillFromXml(xml) {
    try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(xml, "text/xml");
        const ns = {
            ram: "urn:un:unece:uncefact:data:standard:ReusableAggregateBusinessInformationEntity:100"
        };
        const get = (tag) => {
            const el = doc.getElementsByTagNameNS(ns.ram, tag)[0];
            return el ? el.textContent : "";
        };

        // Infos facture
        document.getElementById("invoice_number").value = "COPIE-" + get("ID");
        document.getElementById("payment_terms").value = "";

        // Vendeur
        const parties = doc.getElementsByTagNameNS(ns.ram, "SellerTradeParty");
        if (parties[0]) {
            document.getElementById("seller_name").value = parties[0].getElementsByTagNameNS(ns.ram, "Name")[0]?.textContent || "";
            document.getElementById("seller_siret").value = parties[0].getElementsByTagNameNS(ns.ram, "ID")[0]?.textContent || "";
            document.getElementById("seller_vat").value = parties[0].getElementsByTagNameNS(ns.ram, "ID")[1]?.textContent || "";
            document.getElementById("seller_street").value = parties[0].getElementsByTagNameNS(ns.ram, "LineOne")[0]?.textContent || "";
            document.getElementById("seller_city").value = parties[0].getElementsByTagNameNS(ns.ram, "CityName")[0]?.textContent || "";
            document.getElementById("seller_postal").value = parties[0].getElementsByTagNameNS(ns.ram, "PostcodeCode")[0]?.textContent || "";
        }

        // Acheteur
        const buyers = doc.getElementsByTagNameNS(ns.ram, "BuyerTradeParty");
        if (buyers[0]) {
            document.getElementById("buyer_name").value = buyers[0].getElementsByTagNameNS(ns.ram, "Name")[0]?.textContent || "";
            document.getElementById("buyer_siret").value = buyers[0].getElementsByTagNameNS(ns.ram, "ID")[0]?.textContent || "";
            document.getElementById("buyer_vat").value = buyers[0].getElementsByTagNameNS(ns.ram, "ID")[1]?.textContent || "";
            document.getElementById("buyer_street").value = buyers[0].getElementsByTagNameNS(ns.ram, "LineOne")[0]?.textContent || "";
            document.getElementById("buyer_city").value = buyers[0].getElementsByTagNameNS(ns.ram, "CityName")[0]?.textContent || "";
            document.getElementById("buyer_postal").value = buyers[0].getElementsByTagNameNS(ns.ram, "PostcodeCode")[0]?.textContent || "";
        }

        // Lignes
        const lineItems = doc.getElementsByTagNameNS(ns.ram, "IncludedSupplyChainTradeLineItem");
        document.getElementById("lines-tbody").innerHTML = "";
        lineCount = 0;
        for (let i = 0; i < lineItems.length; i++) {
            addLine();
            const item = lineItems[i];
            document.getElementById("desc-" + lineCount).value = item.getElementsByTagNameNS(ns.ram, "Name")[0]?.textContent || "";
            document.getElementById("qty-" + lineCount).value = item.getElementsByTagNameNS(ns.ram, "BilledQuantity")[0]?.textContent || "1";
            document.getElementById("price-" + lineCount).value = item.getElementsByTagNameNS(ns.ram, "ChargeAmount")[1]?.textContent || "0";
            const vatRate = item.getElementsByTagNameNS(ns.ram, "RateApplicablePercent")[0]?.textContent || "20";
            document.getElementById("vat-" + lineCount).value = vatRate;
        }
        calcTotals();
    } catch(e) {
        console.error("Erreur parsing XML:", e);
    }
}

async function login() {
    apiKey = document.getElementById('api-key-input').value;
    try {
        const res = await fetch(BASE_URL + '/v1/invoices', {
            headers: { 'X-API-Key': apiKey }
        });
        if (res.status === 403) {
            document.getElementById('login-error').textContent = 'Cl√© API invalide';
            return;
        }
        sessionStorage.setItem('apiKey', apiKey);
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
    } catch(e) {
        document.getElementById('login-error').textContent = 'Erreur de connexion';
    }
}

// Connexion automatique si cl√© d√©j√† en session
window.addEventListener('load', async () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('issue_date').value = today;
    const due = new Date();
    due.setDate(due.getDate() + 30);
    document.getElementById('due_date').value = due.toISOString().split('T')[0];
    addLine();

    const savedKey = sessionStorage.getItem('apiKey');
    if (savedKey) {
        apiKey = savedKey;
        try {
            const res = await fetch(BASE_URL + '/v1/invoices', { headers: { 'X-API-Key': apiKey } });
            if (res.ok) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                const duplicateXml = sessionStorage.getItem('duplicateXml');
                if (duplicateXml) {
                    prefillFromXml(duplicateXml);
                    sessionStorage.removeItem('duplicateXml');
                } else {
                    loadSellerTemplate();
                }
            }
        } catch(e) {}
    }
});

function addLine() {
    lineCount++;
    const tbody = document.getElementById('lines-tbody');
    const tr = document.createElement('tr');
    tr.id = `line-${lineCount}`;
    tr.innerHTML = `
        <td><input type="text" placeholder="Description" id="desc-${lineCount}" onchange="calcTotals()" /></td>
        <td><input type="number" value="1" min="0.01" step="0.01" id="qty-${lineCount}" oninput="calcTotals()" /></td>
        <td>
            <select id="unit-${lineCount}">
                <option value="EA">Pi√®ce</option>
                <option value="HUR">Heure</option>
                <option value="DAY">Jour</option>
                <option value="MTR">M√®tre</option>
                <option value="KGM">Kg</option>
            </select>
        </td>
        <td><input type="number" value="0" min="0" step="0.01" id="price-${lineCount}" oninput="calcTotals()" /></td>
        <td>
            <select id="vat-${lineCount}" onchange="calcTotals()">
                <option value="20">20%</option>
                <option value="10">10%</option>
                <option value="5.5">5.5%</option>
                <option value="0">0%</option>
            </select>
        </td>
        <td id="linetotal-${lineCount}">0,00 ‚Ç¨</td>
        <td><button class="btn btn-danger" onclick="removeLine(${lineCount})">‚úï</button></td>
    `;
    tbody.appendChild(tr);
}

function removeLine(id) {
    const tr = document.getElementById(`line-${id}`);
    if (tr) tr.remove();
    calcTotals();
}

function calcTotals() {
    let totalHT = 0, totalVAT = 0;
    for (let i = 1; i <= lineCount; i++) {
        const qty = parseFloat(document.getElementById(`qty-${i}`)?.value || 0);
        const price = parseFloat(document.getElementById(`price-${i}`)?.value || 0);
        const vat = parseFloat(document.getElementById(`vat-${i}`)?.value || 0);
        const lineTotal = qty * price;
        totalHT += lineTotal;
        totalVAT += lineTotal * vat / 100;
        const el = document.getElementById(`linetotal-${i}`);
        if (el) el.textContent = lineTotal.toFixed(2) + " ‚Ç¨";
    }
    document.getElementById('total-ht').textContent = totalHT.toFixed(2) + " ‚Ç¨";
    document.getElementById('total-vat').textContent = totalVAT.toFixed(2) + " ‚Ç¨";
    document.getElementById('total-ttc').textContent = (totalHT + totalVAT).toFixed(2) + " ‚Ç¨";
}

function showAlert(message, type) {
    const box = document.getElementById('alert-box');
    box.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    window.scrollTo(0, 0);
}

function getLines() {
    const lines = [];
    for (let i = 1; i <= lineCount; i++) {
        const desc = document.getElementById(`desc-${i}`);
        if (!desc) continue;
        lines.push({
            id: String(i),
            description: desc.value,
            quantity: parseFloat(document.getElementById(`qty-${i}`).value),
            unit: document.getElementById(`unit-${i}`).value,
            unit_price: parseFloat(document.getElementById(`price-${i}`).value),
            vat_rate: parseFloat(document.getElementById(`vat-${i}`).value)
        });
    }
    return lines;
}

function saveSellerTemplate() {
    const seller = {
        name: document.getElementById('seller_name').value,
        siret: document.getElementById('seller_siret').value,
        vat: document.getElementById('seller_vat').value,
        street: document.getElementById('seller_street').value,
        city: document.getElementById('seller_city').value,
        postal: document.getElementById('seller_postal').value,
        iban: document.getElementById('bank_iban').value,
        payment_terms: document.getElementById('payment_terms').value
    };
    localStorage.setItem('sellerTemplate', JSON.stringify(seller));
    alert('‚úÖ Mod√®le vendeur sauvegard√© !');
}

function loadSellerTemplate() {
    const saved = localStorage.getItem('sellerTemplate');
    if (saved) {
        const seller = JSON.parse(saved);
        document.getElementById('seller_name').value = seller.name || '';
        document.getElementById('seller_siret').value = seller.siret || '';
        document.getElementById('seller_vat').value = seller.vat || '';
        document.getElementById('seller_street').value = seller.street || '';
        document.getElementById('seller_city').value = seller.city || '';
        document.getElementById('seller_postal').value = seller.postal || '';
        document.getElementById('bank_iban').value = seller.iban || '';
        document.getElementById('payment_terms').value = seller.payment_terms || '';
    }
}


async function generateInvoice() {
    const payload = {
        invoice_number: document.getElementById('invoice_number').value,
        issue_date: document.getElementById('issue_date').value,
        due_date: document.getElementById('due_date').value || undefined,
        currency: "EUR",
        seller: {
            name: document.getElementById('seller_name').value,
            siret: document.getElementById('seller_siret').value,
            vat_number: document.getElementById('seller_vat').value,
            address: {
                street: document.getElementById('seller_street').value,
                city: document.getElementById('seller_city').value,
                postal_code: document.getElementById('seller_postal').value,
                country: "FR"
            }
        },
        buyer: {
            name: document.getElementById('buyer_name').value,
            siret: document.getElementById('buyer_siret').value,
            vat_number: document.getElementById('buyer_vat').value,
            address: {
                street: document.getElementById('buyer_street').value,
                city: document.getElementById('buyer_city').value,
                postal_code: document.getElementById('buyer_postal').value,
                country: "FR"
            }
        },
        lines: getLines(),
        payment_terms: document.getElementById('payment_terms').value || undefined,
        bank_iban: document.getElementById('bank_iban').value || undefined
    };

    if (!payload.invoice_number || !payload.issue_date || !payload.seller.name || !payload.buyer.name || payload.lines.length === 0) {
        showAlert("Veuillez remplir tous les champs obligatoires (*)", "error");
        return;
    }

    document.getElementById('spinner').style.display = 'block';

    try {
        const res = await fetch(BASE_URL + '/v1/invoice/generate', {
            method: 'POST',
            headers: { 'X-API-Key': apiKey, 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        document.getElementById('spinner').style.display = 'none';

        if (res.ok) {
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `facture_${payload.invoice_number}.pdf`;
            a.click();
            showAlert("‚úÖ Facture g√©n√©r√©e avec succ√®s !", "success");
        } else {
            const err = await res.json();
            showAlert("‚ùå Erreur : " + JSON.stringify(err.detail || err), "error");
        }
    } catch(e) {
        document.getElementById('spinner').style.display = 'none';
        showAlert("‚ùå Erreur de connexion", "error");
    }
}

document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && document.getElementById('login-screen').style.display !== 'none') {
        login();
    }
});
</script>
</body>
</html>
